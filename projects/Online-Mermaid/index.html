<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mermaid Editor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <style>
    /* ===== Reset & Base ===== */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* ===== Theme Variables ===== */
    [data-theme="light"] {
      --bg-main: #f8f9fa;
      --bg-editor: #ffffff;
      --bg-toolbar: #ffffff;
      --bg-preview: #ffffff;
      --bg-gutter: #f1f3f5;
      --border-color: #e0e0e0;
      --text-color: #1a1a2e;
      --text-muted: #6b7280;
      --text-gutter: #9ca3af;
      --accent: #4f46e5;
      --accent-hover: #4338ca;
      --btn-bg: #f1f3f5;
      --btn-hover: #e5e7eb;
      --btn-active: #d1d5db;
      --error-bg: #fef2f2;
      --error-border: #fca5a5;
      --error-text: #991b1b;
      --error-line-bg: rgba(239, 68, 68, 0.08);
      --error-line-border: #ef4444;
      --select-bg: #f1f3f5;
      --collapse-bg: #e5e7eb;
      --collapse-hover: #d1d5db;
      --scrollbar-thumb: #c1c1c1;
      --scrollbar-track: transparent;
    }

    [data-theme="dark"] {
      --bg-main: #1e1e2e;
      --bg-editor: #252536;
      --bg-toolbar: #252536;
      --bg-preview: #1e1e2e;
      --bg-gutter: #1e1e2e;
      --border-color: #2d2d44;
      --text-color: #e0e0e0;
      --text-muted: #8b8fa3;
      --text-gutter: #5a5e78;
      --accent: #818cf8;
      --accent-hover: #6366f1;
      --btn-bg: #2d2d44;
      --btn-hover: #3a3a56;
      --btn-active: #48486a;
      --error-bg: #3b1c1c;
      --error-border: #7f1d1d;
      --error-text: #fca5a5;
      --error-line-bg: rgba(239, 68, 68, 0.15);
      --error-line-border: #dc2626;
      --select-bg: #2d2d44;
      --collapse-bg: #2d2d44;
      --collapse-hover: #3a3a56;
      --scrollbar-thumb: #3a3a56;
      --scrollbar-track: transparent;
    }

    html, body {
      height: 100%;
      overflow: hidden;
      font-family: 'Inter', -apple-system, system-ui, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-main);
      color: var(--text-color);
      transition: background-color 200ms, color 200ms;
    }

    /* ===== App Shell ===== */
    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* ===== Toolbar ===== */
    .toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 0 16px;
      height: 52px;
      min-height: 52px;
      background: var(--bg-toolbar);
      border-bottom: 1px solid var(--border-color);
      transition: background-color 200ms, border-color 200ms;
      z-index: 10;
    }

    .toolbar-title {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: -0.3px;
      color: var(--text-color);
      white-space: nowrap;
      margin-right: 8px;
      transition: color 200ms;
    }

    .toolbar-title span {
      color: var(--accent);
      transition: color 200ms;
    }

    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
    }

    .toolbar select {
      padding: 6px 28px 6px 10px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: var(--select-bg);
      color: var(--text-color);
      font-family: inherit;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      outline: none;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      transition: background-color 200ms, border-color 200ms, color 200ms;
    }

    .toolbar select:hover {
      border-color: var(--accent);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: var(--btn-bg);
      color: var(--text-color);
      font-family: inherit;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: background-color 150ms, border-color 150ms, color 200ms, transform 100ms;
      outline: none;
    }

    .btn:hover {
      background: var(--btn-hover);
      border-color: var(--accent);
    }

    .btn:active {
      background: var(--btn-active);
      transform: scale(0.97);
    }

    .btn-icon {
      font-size: 15px;
      line-height: 1;
    }

    .theme-btn {
      width: 34px;
      height: 34px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      border-radius: 8px;
    }

    /* ===== Main Layout ===== */
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    /* ===== Editor Panel ===== */
    .editor-panel {
      width: 42%;
      min-width: 0;
      display: flex;
      flex-direction: column;
      background: var(--bg-editor);
      border-right: 1px solid var(--border-color);
      transition: width 250ms ease, background-color 200ms, border-color 200ms, min-width 250ms ease;
      overflow: hidden;
    }

    .editor-panel.collapsed {
      width: 0;
      min-width: 0;
      border-right: none;
    }

    .editor-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-gutter);
      transition: background-color 200ms, border-color 200ms;
    }

    .editor-header-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      transition: color 200ms;
    }

    .editor-body {
      display: flex;
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    .line-gutter {
      width: 48px;
      min-width: 48px;
      padding: 12px 0;
      background: var(--bg-gutter);
      border-right: 1px solid var(--border-color);
      overflow: hidden;
      user-select: none;
      transition: background-color 200ms, border-color 200ms;
    }

    .line-number {
      height: 21px;
      line-height: 21px;
      padding: 0 10px 0 0;
      text-align: right;
      font-family: 'JetBrains Mono', Consolas, 'Courier New', monospace;
      font-size: 13px;
      color: var(--text-gutter);
      border-left: 3px solid transparent;
      transition: color 200ms, background-color 150ms, border-color 150ms;
    }

    .line-number.error-line {
      background: var(--error-line-bg);
      border-left-color: var(--error-line-border);
      color: var(--error-line-border);
    }

    .code-editor {
      flex: 1;
      width: 100%;
      padding: 12px;
      border: none;
      outline: none;
      resize: none;
      font-family: 'JetBrains Mono', Consolas, 'Courier New', monospace;
      font-size: 13px;
      line-height: 21px;
      color: var(--text-color);
      background: var(--bg-editor);
      tab-size: 2;
      white-space: pre;
      overflow-wrap: normal;
      overflow-x: auto;
      overflow-y: auto;
      transition: background-color 200ms, color 200ms;
    }

    .code-editor::placeholder {
      color: var(--text-muted);
    }

    /* Scrollbar styling */
    .code-editor::-webkit-scrollbar,
    .line-gutter::-webkit-scrollbar,
    .preview-panel::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .code-editor::-webkit-scrollbar-track,
    .line-gutter::-webkit-scrollbar-track,
    .preview-panel::-webkit-scrollbar-track {
      background: var(--scrollbar-track);
    }

    .code-editor::-webkit-scrollbar-thumb,
    .line-gutter::-webkit-scrollbar-thumb,
    .preview-panel::-webkit-scrollbar-thumb {
      background: var(--scrollbar-thumb);
      border-radius: 4px;
    }

    /* ===== Collapse Toggle ===== */
    .collapse-btn {
      position: absolute;
      left: 42%;
      top: 50%;
      transform: translate(-50%, -50%);
      z-index: 5;
      width: 24px;
      height: 48px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--collapse-bg);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: left 250ms ease, background-color 200ms, border-color 200ms, color 200ms;
      outline: none;
    }

    .collapse-btn:hover {
      background: var(--collapse-hover);
      color: var(--text-color);
    }

    .collapse-btn.collapsed {
      left: 0;
      transform: translate(0, -50%);
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
    }

    /* ===== Preview Panel ===== */
    .preview-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: auto;
      background: var(--bg-preview);
      position: relative;
      transition: background-color 200ms;
    }

    .error-banner {
      display: none;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 14px;
      margin: 10px 10px 0 10px;
      background: var(--error-bg);
      border: 1px solid var(--error-border);
      border-radius: 8px;
      color: var(--error-text);
      font-size: 13px;
      line-height: 1.5;
      transition: background-color 200ms, border-color 200ms, color 200ms;
    }

    .error-banner.visible {
      display: flex;
    }

    .error-banner-message {
      flex: 1;
      font-family: 'JetBrains Mono', Consolas, monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .error-banner-dismiss {
      background: none;
      border: none;
      color: var(--error-text);
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      padding: 0 2px;
      opacity: 0.7;
      flex-shrink: 0;
    }

    .error-banner-dismiss:hover {
      opacity: 1;
    }

    .diagram-container {
      flex: 1;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 24px;
      overflow: auto;
    }

    .diagram-container svg {
      max-width: 100%;
      height: auto;
    }

    /* ===== Responsive ===== */
    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
      }

      .editor-panel {
        width: 100% !important;
        height: 45%;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
      }

      .editor-panel.collapsed {
        height: 0;
        border-bottom: none;
      }

      .collapse-btn {
        left: 50% !important;
        top: 45%;
        transform: translate(-50%, -50%);
        width: 48px;
        height: 24px;
      }

      .collapse-btn.collapsed {
        top: 0;
        left: 50% !important;
        transform: translate(-50%, 0);
        border-top-left-radius: 0;
        border-top-right-radius: 0;
        border-bottom-left-radius: 6px;
        border-bottom-right-radius: 6px;
      }

      .toolbar {
        flex-wrap: wrap;
        height: auto;
        padding: 8px 12px;
        gap: 6px;
      }

      .toolbar-left, .toolbar-right {
        gap: 6px;
      }

      .btn span.btn-label {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Toolbar -->
    <div class="toolbar">
      <div class="toolbar-left">
        <div class="toolbar-title"><span>&#9670;</span> Mermaid Editor</div>
        <select id="templateSelect" title="Load a template">
          <option value="" disabled selected>Templates</option>
          <option value="flowchart">Flowchart</option>
          <option value="sequence">Sequence Diagram</option>
          <option value="class">Class Diagram</option>
          <option value="gantt">Gantt Chart</option>
          <option value="er">ER Diagram</option>
          <option value="state">State Diagram</option>
          <option value="pie">Pie Chart</option>
        </select>
        <select id="diagramThemeSelect" title="Diagram theme">
          <option value="default">Default</option>
          <option value="neutral">Neutral</option>
          <option value="dark">Dark</option>
          <option value="forest">Forest</option>
          <option value="base">Base</option>
        </select>
      </div>
      <div class="toolbar-right">
        <button class="btn" id="exportPngBtn" title="Export as PNG">
          <span class="btn-icon">&#128247;</span>
          <span class="btn-label">Export PNG</span>
        </button>
        <button class="btn" id="exportSvgBtn" title="Export as SVG">
          <span class="btn-icon">&#10697;</span>
          <span class="btn-label">Export SVG</span>
        </button>
        <button class="btn theme-btn" id="themeToggle" title="Toggle theme">&#9788;</button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-container">
      <!-- Editor Panel -->
      <div class="editor-panel" id="editorPanel">
        <div class="editor-header">
          <span class="editor-header-title">Editor</span>
        </div>
        <div class="editor-body">
          <div class="line-gutter" id="lineGutter"></div>
          <textarea
            class="code-editor"
            id="codeEditor"
            spellcheck="false"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
            placeholder="Type your Mermaid diagram here..."
          ></textarea>
        </div>
      </div>

      <!-- Collapse Toggle -->
      <button class="collapse-btn" id="collapseBtn" title="Toggle editor panel">&#9664;</button>

      <!-- Preview Panel -->
      <div class="preview-panel" id="previewPanel">
        <div class="error-banner" id="errorBanner">
          <div class="error-banner-message" id="errorMessage"></div>
          <button class="error-banner-dismiss" id="errorDismiss" title="Dismiss">&times;</button>
        </div>
        <div class="diagram-container" id="diagramContainer"></div>
      </div>
    </div>
  </div>

  <script>
    (() => {
      /* ===== DOM References ===== */
      const editorPanel = document.getElementById('editorPanel');
      const codeEditor = document.getElementById('codeEditor');
      const lineGutter = document.getElementById('lineGutter');
      const collapseBtn = document.getElementById('collapseBtn');
      const diagramContainer = document.getElementById('diagramContainer');
      const errorBanner = document.getElementById('errorBanner');
      const errorMessage = document.getElementById('errorMessage');
      const errorDismiss = document.getElementById('errorDismiss');
      const themeToggle = document.getElementById('themeToggle');
      const templateSelect = document.getElementById('templateSelect');
      const exportPngBtn = document.getElementById('exportPngBtn');
      const exportSvgBtn = document.getElementById('exportSvgBtn');
      const diagramThemeSelect = document.getElementById('diagramThemeSelect');

      /* ===== State ===== */
      let editorModified = false;
      let renderTimeout = null;
      let renderCounter = 0;
      let currentDiagramTheme = localStorage.getItem('mermaid-editor-diagram-theme') || 'default';

      /* ===== Templates ===== */
      const templates = {
        flowchart: `%% Flowchart: User Authentication Flow
%% Demonstrates decisions, processes, and multiple endpoints

flowchart TD
    A[User visits site] --> B{Is logged in?}
    B -->|Yes| C[Show Dashboard]
    B -->|No| D[Show Login Page]
    D --> E[Enter Credentials]
    E --> F{Valid credentials?}
    F -->|Yes| G[Generate JWT Token]
    G --> H[Store in Cookie]
    H --> C
    F -->|No| I{Attempts > 3?}
    I -->|Yes| J[Lock Account 15min]
    J --> K[Send Alert Email]
    I -->|No| L[Show Error Message]
    L --> D
    C --> M[Load User Preferences]
    M --> N[Render Personalized Content]`,

        sequence: `%% Sequence Diagram: API Request Lifecycle
%% Shows interaction between client, server, cache, and database

sequenceDiagram
    autonumber
    actor User
    participant Client as Frontend App
    participant API as API Gateway
    participant Cache as Redis Cache
    participant DB as PostgreSQL

    User->>Client: Click "Load Data"
    Client->>API: GET /api/products
    API->>Cache: Check cache key
    alt Cache Hit
        Cache-->>API: Return cached data
        API-->>Client: 200 OK (cached)
    else Cache Miss
        Cache-->>API: null
        API->>DB: SELECT * FROM products
        DB-->>API: Result set
        API->>Cache: SET cache key (TTL: 5min)
        API-->>Client: 200 OK (fresh)
    end
    Client-->>User: Render product list
    Note over Client,API: All responses include ETag headers`,

        class: `%% Class Diagram: E-Commerce Domain Model
%% Core entities and their relationships

classDiagram
    class User {
        +String id
        +String email
        +String name
        +Date createdAt
        +login(password) bool
        +updateProfile(data) void
    }

    class Order {
        +String id
        +Date orderDate
        +String status
        +calculateTotal() float
        +cancel() void
    }

    class Product {
        +String id
        +String name
        +float price
        +int stock
        +isAvailable() bool
    }

    class OrderItem {
        +int quantity
        +float unitPrice
        +getSubtotal() float
    }

    class Payment {
        +String method
        +float amount
        +String status
        +process() bool
        +refund() bool
    }

    User "1" --> "*" Order : places
    Order "1" --> "*" OrderItem : contains
    OrderItem "*" --> "1" Product : references
    Order "1" --> "1" Payment : has`,

        gantt: `%% Gantt Chart: Product Launch Timeline
%% Tracks milestones across design, development, and release phases

gantt
    title Product Launch Roadmap 2025
    dateFormat  YYYY-MM-DD
    axisFormat  %b %d

    section Research
    Market Analysis        :done,    r1, 2025-01-06, 14d
    User Interviews        :done,    r2, after r1, 10d
    Requirements Doc       :done,    r3, after r2, 5d

    section Design
    Wireframes             :done,    d1, after r3, 7d
    UI Mockups             :active,  d2, after d1, 10d
    Design Review          :         d3, after d2, 3d

    section Development
    Backend API            :         dev1, after d2, 21d
    Frontend Build         :         dev2, after d2, 25d
    Integration            :         dev3, after dev1, 10d

    section Testing
    QA Testing             :         t1, after dev3, 14d
    Beta Launch            :milestone, m1, after t1, 0d
    Bug Fixes              :         t2, after m1, 10d

    section Release
    Production Deploy      :milestone, m2, after t2, 0d
    Post-launch Monitoring :         rel1, after m2, 14d`,

        er: `%% ER Diagram: Blog Platform Database Schema
%% Entities, attributes, and relationships for a blog system

erDiagram
    USERS {
        uuid id PK
        varchar email UK
        varchar username UK
        varchar password_hash
        text bio
        timestamp created_at
        timestamp updated_at
    }

    POSTS {
        uuid id PK
        uuid author_id FK
        varchar title
        text content
        varchar slug UK
        varchar status
        timestamp published_at
        timestamp created_at
    }

    COMMENTS {
        uuid id PK
        uuid post_id FK
        uuid user_id FK
        text body
        timestamp created_at
    }

    TAGS {
        uuid id PK
        varchar name UK
        varchar slug UK
    }

    POST_TAGS {
        uuid post_id FK
        uuid tag_id FK
    }

    USERS ||--o{ POSTS : writes
    USERS ||--o{ COMMENTS : authors
    POSTS ||--o{ COMMENTS : receives
    POSTS ||--o{ POST_TAGS : categorized
    TAGS ||--o{ POST_TAGS : applied`,

        state: `%% State Diagram: Order Processing Lifecycle
%% Tracks an order from creation through fulfillment

stateDiagram-v2
    [*] --> Draft : Create Order

    Draft --> Submitted : Submit
    Draft --> Cancelled : Cancel

    Submitted --> Processing : Payment Confirmed
    Submitted --> Cancelled : Cancel / Payment Failed

    Processing --> Shipped : Ship Items
    Processing --> OnHold : Issue Detected

    OnHold --> Processing : Issue Resolved
    OnHold --> Cancelled : Cannot Resolve

    Shipped --> Delivered : Delivery Confirmed
    Shipped --> Returned : Return Requested

    Delivered --> Completed : After 30 days
    Delivered --> Returned : Return Requested

    Returned --> Refunded : Refund Processed
    Refunded --> [*]
    Completed --> [*]
    Cancelled --> [*]

    note right of Processing
        Inventory is reserved
        while in this state
    end note`,

        pie: `%% Pie Chart: Tech Stack Usage Survey 2025
%% Developer tool preferences from annual survey

pie showData
    title Developer Primary Language (2025 Survey)
    "JavaScript/TypeScript" : 28.5
    "Python" : 22.3
    "Java" : 12.8
    "C#" : 9.4
    "Go" : 7.6
    "Rust" : 5.2
    "C/C++" : 4.8
    "PHP" : 4.1
    "Other" : 5.3`
      };

      const defaultTemplate = templates.flowchart;

      /* ===== Mermaid Init ===== */
      function initMermaid() {
        mermaid.initialize({
          startOnLoad: false,
          theme: currentDiagramTheme,
          securityLevel: 'loose',
          fontFamily: 'Inter, -apple-system, system-ui, sans-serif'
        });
      }

      initMermaid();

      /* ===== Line Numbers ===== */
      function updateLineNumbers() {
        const text = codeEditor.value;
        const lineCount = text.split('\n').length;
        let html = '';
        for (let i = 1; i <= lineCount; i++) {
          html += `<div class="line-number" data-line="${i}">${i}</div>`;
        }
        lineGutter.innerHTML = html;
      }

      /* ===== Synchronized Scroll ===== */
      codeEditor.addEventListener('scroll', () => {
        lineGutter.scrollTop = codeEditor.scrollTop;
      });

      /* ===== Tab Key Support ===== */
      codeEditor.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
          e.preventDefault();
          const start = codeEditor.selectionStart;
          const end = codeEditor.selectionEnd;
          const value = codeEditor.value;
          codeEditor.value = value.substring(0, start) + '  ' + value.substring(end);
          codeEditor.selectionStart = codeEditor.selectionEnd = start + 2;
          handleInput();
        }
      });

      /* ===== Input Handling ===== */
      function handleInput() {
        editorModified = true;
        updateLineNumbers();
        debouncedRender();
      }

      codeEditor.addEventListener('input', handleInput);

      /* ===== Debounced Render ===== */
      function debouncedRender() {
        clearTimeout(renderTimeout);
        renderTimeout = setTimeout(renderDiagram, 300);
      }

      /* ===== Error Handling ===== */
      function clearErrors() {
        errorBanner.classList.remove('visible');
        errorMessage.textContent = '';
        const errorLines = lineGutter.querySelectorAll('.error-line');
        errorLines.forEach(el => el.classList.remove('error-line'));
      }

      function showError(msg) {
        errorMessage.textContent = msg;
        errorBanner.classList.add('visible');

        const lineMatch = msg.match(/line\s+(\d+)/i)
          || msg.match(/row\s+(\d+)/i)
          || msg.match(/at\s+line\s+(\d+)/i)
          || msg.match(/Parse error on line (\d+)/i);

        if (lineMatch) {
          const lineNum = parseInt(lineMatch[1], 10);
          const lineEl = lineGutter.querySelector(`[data-line="${lineNum}"]`);
          if (lineEl) {
            lineEl.classList.add('error-line');
          }
        }
      }

      errorDismiss.addEventListener('click', () => {
        errorBanner.classList.remove('visible');
      });

      /* ===== Mermaid Rendering ===== */
      async function renderDiagram() {
        const code = codeEditor.value.trim();
        if (!code) {
          diagramContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 14px;">Start typing to see your diagram...</p>';
          clearErrors();
          return;
        }

        renderCounter++;
        const id = `mermaid-graph-${renderCounter}`;

        try {
          const { svg } = await mermaid.render(id, code);
          diagramContainer.innerHTML = svg;
          clearErrors();
        } catch (err) {
          const errEl = document.getElementById('d' + id);
          if (errEl) errEl.remove();

          const message = err?.message || err?.str || String(err);
          showError(message);
        }
      }

      /* ===== UI Theme Toggle (Light/Dark) ===== */
      function setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        themeToggle.innerHTML = theme === 'dark' ? '&#9790;' : '&#9788;';
        themeToggle.title = theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode';
        localStorage.setItem('mermaid-editor-theme', theme);

        clearTimeout(renderTimeout);
        renderDiagram();
      }

      themeToggle.addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-theme');
        setTheme(current === 'dark' ? 'light' : 'dark');
      });

      /* ===== Diagram Theme Selector ===== */
      function setDiagramTheme(theme) {
        currentDiagramTheme = theme;
        localStorage.setItem('mermaid-editor-diagram-theme', theme);
        diagramThemeSelect.value = theme;
        initMermaid();
        clearTimeout(renderTimeout);
        renderDiagram();
      }

      diagramThemeSelect.addEventListener('change', () => {
        setDiagramTheme(diagramThemeSelect.value);
      });

      /* ===== Collapse/Expand Editor ===== */
      collapseBtn.addEventListener('click', () => {
        const isCollapsed = editorPanel.classList.toggle('collapsed');
        collapseBtn.classList.toggle('collapsed', isCollapsed);
        collapseBtn.innerHTML = isCollapsed ? '&#9654;' : '&#9664;';
        collapseBtn.title = isCollapsed ? 'Show editor panel' : 'Hide editor panel';
      });

      /* ===== Templates ===== */
      templateSelect.addEventListener('change', () => {
        const key = templateSelect.value;
        if (!key || !templates[key]) return;

        if (editorModified) {
          const confirmed = confirm('Replace current editor content with the selected template?');
          if (!confirmed) {
            templateSelect.selectedIndex = 0;
            return;
          }
        }

        codeEditor.value = templates[key];
        editorModified = false;
        updateLineNumbers();
        codeEditor.scrollTop = 0;
        lineGutter.scrollTop = 0;
        clearTimeout(renderTimeout);
        renderDiagram();
        templateSelect.selectedIndex = 0;
      });

      /* ===== Export SVG ===== */
      function exportSVG() {
        const svgEl = diagramContainer.querySelector('svg');
        if (!svgEl) {
          alert('No diagram to export. Please create a valid diagram first.');
          return;
        }

        const clone = svgEl.cloneNode(true);
        clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
        clone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');

        const serializer = new XMLSerializer();
        const svgString = serializer.serializeToString(clone);
        const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
        downloadBlob(blob, `mermaid-diagram-${Date.now()}.svg`);
      }

      /* ===== Export PNG ===== */
      function exportPNG() {
        const svgEl = diagramContainer.querySelector('svg');
        if (!svgEl) {
          alert('No diagram to export. Please create a valid diagram first.');
          return;
        }

        const clone = svgEl.cloneNode(true);
        clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
        clone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');

        const serializer = new XMLSerializer();
        const svgString = serializer.serializeToString(clone);

        const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(svgBlob);

        const img = new Image();
        img.onload = () => {
          const scale = 2;
          const canvas = document.createElement('canvas');
          canvas.width = img.naturalWidth * scale;
          canvas.height = img.naturalHeight * scale;
          const ctx = canvas.getContext('2d');

          const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
          ctx.fillStyle = isDark ? '#1e1e2e' : '#ffffff';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

          URL.revokeObjectURL(url);

          canvas.toBlob((blob) => {
            if (blob) {
              downloadBlob(blob, `mermaid-diagram-${Date.now()}.png`);
            }
          }, 'image/png');
        };

        img.onerror = () => {
          URL.revokeObjectURL(url);
          alert('Failed to generate PNG. Try exporting as SVG instead.');
        };

        img.src = url;
      }

      function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      exportSvgBtn.addEventListener('click', exportSVG);
      exportPngBtn.addEventListener('click', exportPNG);

      /* ===== Initialize ===== */
      function init() {
        const savedTheme = localStorage.getItem('mermaid-editor-theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        themeToggle.innerHTML = savedTheme === 'dark' ? '&#9790;' : '&#9788;';
        themeToggle.title = savedTheme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode';

        diagramThemeSelect.value = currentDiagramTheme;
        initMermaid();

        codeEditor.value = defaultTemplate;
        editorModified = false;
        updateLineNumbers();
        renderDiagram();
      }

      init();
    })();
  </script>
</body>
</html>
