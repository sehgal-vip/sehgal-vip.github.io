const CommandPalette={overlay:null,input:null,results:null,items:[],filteredItems:[],selectedIndex:0,init(){if(this.overlay=document.getElementById("command-palette-overlay"),this.input=document.getElementById("command-input"),this.results=document.getElementById("command-results"),!this.overlay||!this.input||!this.results)return;this.loadItems(),this.bindEvents(),this.render()},loadItems(){this.items=[{type:"action",id:"theme-toggle",label:ThemeManager.getTheme()==="dark"?"Switch to Light Mode":"Switch to Dark Mode",icon:ThemeManager.getTheme()==="dark"?"â˜€ï¸":"ðŸŒ™",keywords:["theme","dark","light","mode","toggle","switch"],group:"Actions"},{type:"section",label:"Go to Currently",action:"#currently",icon:"â†’",keywords:["currently","now","about"],group:"Navigation"},{type:"section",label:"Go to Writing",action:"#writing",icon:"â†’",keywords:["writing","blog","posts","articles"],group:"Navigation"},{type:"section",label:"Go to Projects",action:"#projects",icon:"â†’",keywords:["projects","work","portfolio"],group:"Navigation"},{type:"section",label:"Go to Talks",action:"#talks",icon:"â†’",keywords:["talks","media","podcast","video"],group:"Navigation"},{type:"section",label:"Go to Links",action:"#links",icon:"â†’",keywords:["links","social","connect"],group:"Navigation"},{type:"section",label:"Go to Photography",action:"#photography",icon:"â†’",keywords:["photography","photos","images"],group:"Navigation"},{type:"section",label:"View All Posts",action:"/writing/",icon:"â†’",keywords:["all","posts","archive","blog"],group:"Navigation"},{type:"action",id:"copy-url",label:"Copy Current URL",icon:"ðŸ“‹",keywords:["copy","url","link","share"],group:"Actions"},{type:"action",id:"rss",label:"Subscribe to RSS",icon:"ðŸ“¡",keywords:["rss","feed","subscribe"],group:"Actions"}];try{const e=document.getElementById("search-index");if(e){const t=JSON.parse(e.textContent);t.posts&&t.posts.forEach(e=>{this.items.push({type:"post",label:e.title,action:e.url,icon:"ðŸ“",keywords:[e.title.toLowerCase(),...(e.tags||[]).map(e=>e.toLowerCase())],meta:e.date,group:"Posts"})}),t.links&&t.links.forEach(e=>{this.items.push({type:"link",label:e.name,action:e.url,icon:"â†—",keywords:[e.name.toLowerCase(),"social","external"],group:"External"})})}}catch(e){console.error("Failed to load search index:",e)}this.filteredItems=[...this.items]},bindEvents(){document.addEventListener("keydown",e=>{(e.metaKey||e.ctrlKey)&&e.key==="k"&&(e.preventDefault(),this.open()),e.key==="Escape"&&this.isOpen()&&(e.preventDefault(),this.close())}),this.overlay.addEventListener("click",e=>{e.target===this.overlay&&this.close()}),this.input.addEventListener("input",()=>{this.filter(this.input.value)}),this.input.addEventListener("keydown",e=>{e.key==="ArrowDown"?(e.preventDefault(),this.moveSelection(1)):e.key==="ArrowUp"?(e.preventDefault(),this.moveSelection(-1)):e.key==="Enter"&&(e.preventDefault(),this.executeSelected())})},isOpen(){return this.overlay.classList.contains("active")},open(){this.overlay.classList.add("active"),this.input.value="",this.filter(""),this.input.focus(),document.body.style.overflow="hidden";const e=this.items.find(e=>e.id==="theme-toggle");if(e){const t=ThemeManager.getTheme();e.label=t==="dark"?"Switch to Light Mode":"Switch to Dark Mode",e.icon=t==="dark"?"â˜€ï¸":"ðŸŒ™"}this.render()},close(){this.overlay.classList.remove("active"),document.body.style.overflow="",this.input.blur()},filter(e){e=e.toLowerCase().trim(),e?this.filteredItems=this.items.filter(t=>{const n=t.label.toLowerCase().includes(e),s=t.keywords?.some(t=>t.includes(e));return n||s}):this.filteredItems=[...this.items],this.selectedIndex=0,this.render()},moveSelection(e){const t=this.filteredItems.filter(e=>e.type!=="divider");if(t.length===0)return;this.selectedIndex=(this.selectedIndex+e+t.length)%t.length,this.render();const n=this.results.querySelector(".command-item.selected");n&&n.scrollIntoView({block:"nearest"})},executeSelected(){const t=this.filteredItems.filter(e=>e.type!=="divider"),e=t[this.selectedIndex];if(!e)return;this.executeItem(e)},executeItem(e){switch(e.type){case"section":if(e.action.startsWith("#")){const t=document.querySelector(e.action);t&&(this.close(),t.scrollIntoView({behavior:"smooth"}))}else window.location.href=e.action;break;case"post":case"link":e.action.startsWith("http")?window.open(e.action,"_blank"):window.location.href=e.action,this.close();break;case"action":this.handleAction(e.id);break}},handleAction(e){switch(e){case"theme-toggle":ThemeManager.toggle();const e=this.items.find(e=>e.id==="theme-toggle");if(e){const t=ThemeManager.getTheme();e.label=t==="dark"?"Switch to Light Mode":"Switch to Dark Mode",e.icon=t==="dark"?"â˜€ï¸":"ðŸŒ™"}this.render();break;case"copy-url":navigator.clipboard.writeText(window.location.href).then(()=>{this.close()});break;case"rss":window.location.href="/index.xml";break}},render(){if(!this.results)return;const e={};let n=0;this.filteredItems.forEach(t=>{const s=t.group||"Other";e[s]||(e[s]=[]),e[s].push({...t,selectableIndex:n++})});let t="";Object.entries(e).forEach(([e,n])=>{t+=`<div class="command-group-label">${e}</div>`,n.forEach(e=>{const n=e.selectableIndex===this.selectedIndex;t+=`
          <div class="command-item${n?" selected":""}" 
               data-index="${e.selectableIndex}"
               data-command-id="${e.id||""}"
               onclick="CommandPalette.executeItem(CommandPalette.filteredItems[${e.selectableIndex}])">
            <span class="command-icon">${e.icon}</span>
            <span class="command-label">${e.label}</span>
            ${e.meta?`<span class="command-meta" style="color: var(--color-text-muted); font-size: 0.75rem;">${e.meta}</span>`:""}
          </div>
        `})}),this.filteredItems.length===0&&(t='<div class="command-item" style="color: var(--color-text-muted); cursor: default;">No results found</div>'),this.results.innerHTML=t}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>CommandPalette.init()):CommandPalette.init(),window.CommandPalette=CommandPalette